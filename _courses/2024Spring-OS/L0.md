---
layout: post
title: L0ï¼šä¸ºè®¡ç®—æœºç¡¬ä»¶ç¼–ç¨‹
---

> ##### â°Soft Deadline: 2024 å¹´ 4 æœˆ 7 æ—¥ 23:59:59
> ä½ éœ€è¦é¦–å…ˆé˜…è¯»[å®éªŒé¡»çŸ¥](../lab)ï¼Œå…¶ä¸­åŒ…å«äº†ä»£ç è·å–æ–¹æ³•ã€æäº¤æ–¹æ³•ã€å¦‚ä½•æŸ¥çœ‹æäº¤ç»“æœç­‰ã€‚åœ¨å‘½ä»¤è¡Œä¸­ `git pull origin L0` ä¸‹è½½æ¡†æ¶ä»£ç ã€‚
{: .block-warning}


### 1\. èƒŒæ™¯

å¦‚ä½•ä¸ºè®¡ç®—æœºç¡¬ä»¶ç¼–ç¨‹ï¼Ÿæˆ‘ä»¬çš„è®¡ç®—æœºç¡¬ä»¶ä¸Šå¯ä»¥ç›´æ¥è¿è¡Œæˆ‘ä»¬ç¼–å†™çš„ C ä»£ç ï¼Œå°±åƒä¸Šè¯¾æ—¶å±•ç¤ºçš„ Hello Worldï¼š

```c
#include <am.h>
#include <klib.h>

int main() {
    printf("Hello, OS World\n");
}
```

è¿™ä¸ªç¨‹åºé™¤äº†è°ƒç”¨çš„åº“å‡½æ•°ä¸åŒ (ä¾‹å¦‚æ²¡æœ‰ stdio.hï¼›å¤šäº† am.h) ä¹‹å¤–ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªå®Œå…¨ç¬¦åˆ C æ ‡å‡†çš„æ™®é€šç¨‹åºï¼Œä½†å› ä¸ºæ²¡æœ‰æ“ä½œç³»ç»Ÿå’Œæ ‡å‡†åº“çš„æ”¯æŒï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™æ‰€æœ‰çš„åº“å‡½æ•°ã€‚ä¾‹å¦‚ï¼Œprintf ä¹Ÿæ¥è‡ªæˆ‘ä»¬çš„ä»£ç ï¼Œå®ƒè°ƒç”¨äº† AbstractMachine æä¾›çš„ putch API:

```c
void putch(char ch);
```


putch ä¼šåœ¨è°ƒè¯•ç»ˆç«¯ä¸Šè¾“å‡ºä¸€ä¸ªå­—ç¬¦ï¼›å¯¹äº x86-qemu å¹³å°æ¥è¯´ï¼Œè°ƒè¯•ç»ˆç«¯å°±æ˜¯ QEMU çš„ä¸²å£ã€‚

> æˆ‘ä»¬ä½¿ç”¨å®éªŒæ¡†æ¶åœ¨ bare-metal ä¸Šè¿è¡Œäº† Hello Worldï¼Œè¿™ä¹Ÿæ˜¯ â€œæœ€å°â€ æ“ä½œç³»ç»Ÿçš„é›å½¢â€”â€”ä½ å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šå®ç°ä»»ä½•æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚é€šè¿‡é€‚å½“çš„ gdb æŒ‡ä»¤ (è¿™æ¬¡æ˜¯æ›´å¥½ç”¨çš„ Pythonï¼Œå–ä»£äº†å†å²é—ç•™çš„ gdb scripts)ï¼Œæˆ‘ä»¬å®Œæˆé…ç½®çš„åŒæ—¶æŒ‡å®šæ­£ç¡®çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè°ƒè¯•ç¡¬ä»¶ä¸Šçš„ä»£ç ï¼Œä¸è°ƒè¯•æ™®é€šçš„ç¨‹åºå®Œå…¨æ²¡æœ‰åŒºåˆ«ã€‚
> <br><br>
> å¦‚æœå¸Œæœ›æ·±å…¥äº†è§£ç¼–è¯‘çš„å…¨è¿‡ç¨‹ï¼Œéµå¾ª â€œä¸€åˆ‡éƒ½æ˜¯çŠ¶æ€æœºâ€ çš„åŸç†ï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿ Makefile (ç¨‹åº)ï¼Œä¹Ÿå¯ä»¥è§‚å¯Ÿå®ƒçš„æ‰§è¡Œï¼Œè€Œå®ƒçš„æ‰§è¡Œå°±æ˜¯ä¸€ä¸ªä¸ªçš„å‘½ä»¤ã€‚`make log` å¯¹è¾“å‡ºçš„æ—¥å¿—åšäº†ä¸€äº›ç®€åŒ–å¤„ç†ï¼Œå·²ç»è¶³å¤Ÿäººç±»å¯è¯»ï¼Œç¨åŠ æ•´ç†å°±èƒ½çœ‹åˆ°ç£ç›˜é•œåƒçš„ç¼–è¯‘è¿‡ç¨‹ã€‚ä½ ä¹Ÿè®¸ä¼šæ„Ÿåˆ°æœ‰äº›åƒæƒŠï¼šä¸–ç•Œä¸Šæ‰€æœ‰æ“ä½œç³»ç»Ÿçš„æ„å»ºè¿‡ç¨‹ (ä¾‹å¦‚ Linux)ï¼Œéƒ½å’Œè¿™ä¸ªç®€åŒ–ç‰ˆç±»ä¼¼ï¼Œåªæ˜¯å¤šäº†æ›´å¤šå®ç”¨çš„ç‰¹æ€§ï¼šæ”¯æŒåˆ†åŒºè¡¨ã€æ”¯æŒå‹ç¼©/è§£å‹ç¼©ç­‰ã€‚
{: .block-tip}

### 2\. å®éªŒæè¿°

#### 2.1 ç†è§£æ¡†æ¶ä»£ç 

> ##### ğŸ—’ï¸å®éªŒè¦æ±‚ï¼šé˜…è¯» AbstractMachine æ–‡æ¡£
>
> æƒ³çŸ¥é“ä¸ºä»€ä¹ˆèƒ½ç”¨ä½ ç†Ÿæ‚‰çš„æ–¹å¼ç¼–å†™æ“ä½œç³»ç»Ÿï¼Ÿ[é˜…è¯» AbstractMachineçš„æ–‡æ¡£](https://jyywiki.cn/OS/AbstractMachine/index.html)ã€‚å½“ç„¶ï¼Œæ–‡æ¡£å¾ˆå¤šï¼Œä½ ä¸å¿…ä¸€æ¬¡çœ‹å®Œï¼Œå»ºç«‹äº†ä¸€äº›åŸºæœ¬æ¦‚å¿µåï¼Œå°±å¯ä»¥è¯•ç€ä»æ ·ä¾‹ä»£ç å‡ºå‘å¼€å§‹ç¼–ç¨‹äº†ã€‚å¦ä¸€ä¸ªå¥½æ¶ˆæ¯æ˜¯æˆ‘ä»¬çš„å®éªŒæ¡†æ¶ä¸­ç›´æ¥åŒ…å«äº† AbstractMachine çš„ä»£ç å¹¶åœ¨ Makefile ä¸­å®Œæˆäº†é…ç½® (RTFSC)ï¼Œä»è€Œä½ æ— éœ€é¢å¤–é…ç½®/ä¸‹è½½ã€‚
{: .block-tip}

> ##### ğŸ’¡å¯é€‰å®éªŒï¼šå®ç° klib ä¸­ç¼ºå¤±çš„å‡½æ•°
>
> æˆ‘ä»¬è¯¾å ‚ä¸Šæ¼”ç¤ºçš„ä»£ç ä¸­ï¼Œklib å·²ç»è¢«æ­£ç¡®å®ç°ï¼›ä½†ä½ çš„æ¡†æ¶ä»£ç ä¸­ï¼Œè¿™éƒ¨åˆ†å®ç°æ˜¯ç©ºç¼ºçš„ã€‚å¦‚æœä½ æƒ³åªç”¨ `putch` æ‰“å°ï¼Œä¼šä½¿ä½ è¿æ‰“å°ä¸€ä¸ªæ•´æ•°éƒ½éº»çƒ¦åˆ°æ€€ç–‘äººç”Ÿã€‚æ¡†æ¶ä¸­å·²ç»åœ¨ klib.h åˆ—å‡ºäº†ä¸€äº›å‡½æ•°çš„åŸå‹ä¾›å¤§å®¶å‚è€ƒï¼›æˆ‘ä»¬ä¸å¼ºåˆ¶å®ç° klib å‡½æ•°ï¼Œä½†éšç€æ“ä½œç³»ç»Ÿå®éªŒçš„è¿›å±•ï¼Œä½ ä¼šä½“ä¼šåˆ°ä¸å®ç°åº“å‡½æ•°çš„è‹¦å¤´ã€‚å¦‚æœä½ å¯¹ç¼–ç¨‹æ„Ÿåˆ°å¾ˆè‹¦æ¼ï¼Œä¸å¦¨æŒ‰åªå®ç°ä¸€äº›ç®€åŒ–ç‰ˆæœ¬çš„åº“ï¼Œæ— éœ€å…¨éƒ¨å®ç°ï¼›éšç€å®éªŒçš„è¿›å±•åç»­è¡¥é½ã€‚
{: .block-tip}

klibè¿™éƒ¨åˆ†ä»£ç å¯¹ä½ æ¥è¯´åº”è¯¥éå¸¸é‡è¦â€”â€”ä¼šä¸€ç›´ä½¿ç”¨åˆ°è¿™å­¦æœŸçš„æœ€åï¼Œå› æ­¤ä¹Ÿè¯·ä½ éå¸¸å°å¿ƒåœ°ç¼–å†™ä»£ç ï¼Œä¾‹å¦‚ç¼–å†™ç›¸å½“å¤šçš„ assertionsï¼›klib ä¸­çš„ bug ä¼šä½¿åŸæœ¬å°±å·²å¾ˆå›°éš¾çš„æ“ä½œç³»ç»Ÿå†…æ ¸è°ƒè¯•æ›´åŠ ä»¤äººæ²®ä¸§ã€‚

#### 2.2 åœ¨ AbstractMachine ä¸­æ˜¾ç¤ºä¸€å¼ å›¾ç‰‡

> ##### ğŸ—’ï¸å®éªŒè¦æ±‚ï¼šæ˜¾ç¤ºä¸€å¼ å›¾ç‰‡
> ä½ éœ€è¦ç¼–å†™ä¸€ä¸ªç›´æ¥è¿è¡Œåœ¨ AbstractMachine ä¸Š (ä»…ä»…å¯ç”¨ IOE æ‰©å±•ï¼Œä¸ä½¿ç”¨å…¶ä»–ç¡¬ä»¶æœºåˆ¶å¦‚ä¸­æ–­/å¼‚å¸¸/è™šæ‹Ÿå­˜å‚¨/å¤šå¤„ç†å™¨) çš„ç¨‹åºï¼Œæ˜¾ç¤ºä¸€å¼ å›¾ç‰‡ï¼›æ»¡è¶³ï¼š
>
> 1. æ˜¾ç¤ºä¸€å¼ ä»»ä½•å›¾ç‰‡ï¼Œä½†èƒ½é€‚é…ä¸åŒçš„å±å¹•å¤§å°ã€‚ç¡®ä¿ä½ çš„å›¾ç‰‡åœ¨ `320Ã—200` ï¼Œ`320x200`ï¼Œ`320Ã—200`ã€`640Ã—480`ï¼Œ `640 x480`ï¼Œ `640Ã—480`ï¼Œ`800x600` ï¼Œ`800Ã—600` ç­‰åˆ†è¾¨ç‡ä¸‹å‡å¯ä»¥æ­£å¸¸æ˜¾ç¤ºï¼›
> 2. å›¾ç‰‡ä¸­åŒ…å«ä¸å°‘äº 10 ç§é¢œè‰²ã€‚
> 3. ç¨‹åºä½¿ç”¨çš„å†…å­˜ (ä»£ç ã€é™æ€æ•°æ®æ€»å’Œä¸è¶…è¿‡ 4 MiBã€å †åŒº `heap` ä½¿ç”¨ä¸è¶…è¿‡ 4 MiB)ï¼›
> 4. æŒ‰ ESC é”®åè°ƒç”¨ `halt()` é€€å‡ºï¼›é™¤æ­¤ä¹‹å¤–ï¼ŒæŒ‰ä»»ä½•é”®ç¨‹åºéƒ½ä¸åº”é€€å‡ºã€‚
{: .block-tip}




> ##### ğŸ’¡ç§»æ¤æ€§è¦æ±‚
>
> ä½ çš„ä»£ç åº”å½“æœ‰ä¸€å®šçš„å¯ç§»æ¤æ€§ï¼šåŒ minilabs ä¸€æ ·ï¼Œä½ çš„ç¨‹åºå¯èƒ½è¿è¡Œåœ¨ 32/64-bit å¹³å°ï¼Œå› æ­¤ä½ åº”å½“ä½¿ç”¨ `intptr_t` æˆ– `uintptr_t` æ¥ä¿å­˜æŒ‡é’ˆæ•°å€¼ã€‚
>
> æˆ‘ä»¬ä¼šåœ¨ x86_64-qemu (64-bit) å’Œ x86-qemu (32-bit) ä¸¤ä¸ªç¯å¢ƒä¸‹è¿è¡Œï¼Œä½ çš„ç¨‹åºå¿…é¡»åœ¨ä¸¤ä¸ªç¯å¢ƒä¸‹éƒ½èƒ½æ­£ç¡®ç¼–è¯‘å¹¶è¿è¡Œè‰¯å¥½ã€‚æ­¤å¤–ï¼ŒAbstractMachine å‡è®¾ bare-metal ä¸æ”¯æŒæµ®ç‚¹æ•°æŒ‡ä»¤ã€‚åœ¨ x86_64 çš„ç¼–è¯‘é€‰é¡¹ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº† `-mno-sse`ã€‚å°½ç®¡æœ‰æµ®ç‚¹æ•°çš„ç¨‹åºåœ¨ `ARCH=native` ä¸‹å¯ä»¥æ­£ç¡®ç¼–è¯‘è¿è¡Œï¼Œä½†å¯èƒ½åœ¨å…¶ä»–æ¶æ„ä¸‹å¤±æ•ˆã€‚è¿™ä¹ˆåšçš„ç›®çš„æ˜¯ä½¿ AbstractMachine ç¨‹åºèƒ½è¿è¡Œåœ¨å„ç§ (ç®€åŒ–) çš„å¤„ç†å™¨ä¸Šã€‚
{: .block-tip}

### 3\. æ­£ç¡®æ€§æ ‡å‡†

Online Judge ä¼šä¸¥æ ¼æŒ‰ç…§ä¸Šé¢çš„è¦æ±‚æ¥è¯„æµ‹ï¼š

  * æˆ‘ä»¬ä¼šé€šè¿‡ qemu çš„ `-m` é€‰é¡¹é™åˆ¶å†…å­˜çš„å¤§å°ï¼›ä½¿ç”¨è¶…è¿‡è§„å®šçš„å†…å­˜å¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒã€‚åŒå­¦ä»¬å¯ä»¥ç”¨ size å‘½ä»¤æŸ¥çœ‹äºŒè¿›åˆ¶æ–‡ä»¶çš„å¤§å°ã€‚
  * æˆ‘ä»¬ä¼šåœ¨ä¸åŒçš„ç¯å¢ƒä¸‹ (x86-qemu æˆ– x86_64-qemu, native) è¿è¡Œä½ çš„ç¨‹åºï¼Œå¹¶ä¸”å¯èƒ½ä¿®æ”¹å±å¹•çš„åˆ†è¾¨ç‡ (æˆ‘ä»¬çš„ AbstractMachine å¯èƒ½æ‹¥æœ‰å’Œä½ ä¸åŒçš„åˆ†è¾¨ç‡ï¼)ã€‚
  * æˆ‘ä»¬ä¼šå‘ä½ çš„ç¨‹åºå‘é€ä¸€å®šæ•°é‡çš„éšæœºé”®ç›˜äº‹ä»¶ã€‚

æ²¡é”™ï¼ŒOnline Judge ä¼šè‡ªåŠ¨è¿è¡Œä½ çš„ç¨‹åºâ€”â€”è¿™æ„å‘³ç€ä½ ä¹Ÿå¯ä»¥è‡ªåŠ¨è¿è¡Œä½ çš„ç¨‹åºï¼Œå®ç°æœ¬åœ°çš„è‡ªåŠ¨åŒ–æµ‹è¯•ã€‚Online Judge ä¼šä½œå‡ºå¦‚ä¸‹æ­£ç¡®æ€§æ£€æŸ¥ï¼š

  1. é™¤éæŒ‰ ESC é”®ï¼Œæˆ‘ä»¬å‡è®¾ç¨‹åºä¸ç»“æŸï¼›å¦‚æœæ£€æµ‹åˆ° `halt()` çš„è°ƒç”¨ (åŒ…æ‹¬ assert å¤±è´¥ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå¢åŠ ä¸€äº›é¢å¤–çš„åˆæ³•æ€§æ£€æŸ¥)ï¼Œå°†åˆ¤å®šä¸ºé”™ (Runtime Error æˆ– Wrong Answer)ï¼›
  2. å¦‚æœæŒ‰ ESC é”®åç¨‹åºä¸ç»“æŸï¼Œå°†åˆ¤å®šä¸ºé”™ï¼›
  3. å¦‚æœè™šæ‹Ÿæœºæˆ–è¿›ç¨‹å‘ç”Ÿå´©æºƒã€éé¢„æœŸçš„é‡å¯ç­‰ (ç”± undefined behavior å¯¼è‡´ï¼Œä¾‹å¦‚è®¿é—®æŸéæ³•å†…å­˜å¯èƒ½å¯¼è‡´å¼‚å¸¸æˆ– CPU Reset)ï¼Œåˆ™è¢«åˆ¤å®šä¸ºé”™ï¼›
  4. å…¶ä»–è¿å specifications çš„é—®é¢˜ï¼Œå¦‚åœ¨ `ioe_init()` ä¹‹å‰è°ƒç”¨ `io_read`/`io_write`ï¼Œå°†è¢«åˆ¤å®šä¸ºé”™ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬ä¼šé“¾æ¥æˆ‘ä»¬ klib çš„å‚è€ƒå®ç°ï¼Œå› æ­¤ä½ ä¸å¿…æ‹…å¿ƒä½ çš„ klib æœ‰äº›è®¸é—®é¢˜ï¼›ä½†ä½ è¦ä¿æŒ klib åº“å‡½æ•°çš„è¡Œä¸ºä¸ libc ä¸€è‡´ã€‚æ³¨æ„ native ä¼šé“¾æ¥ç³»ç»Ÿæœ¬åœ°çš„ glibc (è€Œé klib)ã€‚

### 4\. å®éªŒæŒ‡å—

> ##### â˜•ï¸é˜…è¯»æ‰‹å†Œ
>
> é¦–å…ˆï¼Œ[AbstractMachine çš„æ–‡æ¡£](/AbstractMachine) æ˜¯å¸®åŠ©ä½ ç†è§£æ•´ä¸ªæ¡†æ¶ä»£ç çš„æ ¸å¿ƒã€‚é˜…è¯»å®ƒï¼Œäº†è§£åˆ°åº•ä¸ºä»€ä¹ˆâ€œæ“ä½œç³»ç»Ÿå°±æ˜¯ä¸€ä¸ª C ç¨‹åºâ€ï¼›ä½ ä¹Ÿå¯ä»¥å‚è€ƒ[è¯¾ç¨‹](https://jyywiki.cn/OS/2024/lect3.md)ä¸­çš„è°ƒè¯•æŠ€å·§ã€‚
{: .block-tip}

#### 4.1. å®ç°åº“å‡½æ•°

å®ç°åº“å‡½æ•°æ˜¯æ™®é€šçš„ C è¯­è¨€ç»ƒä¹ é¢˜ï¼›äº’è”ç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šä»£ç å¯ä»¥å‚è€ƒï¼›å°¤å…¶æ˜¯ä½ å¯ä»¥å¤šå‘å¤§è¯­è¨€æ¨¡å‹æé—®â€”â€”ä½†æˆ‘ä»¬ä¸å»ºè®®å¤§å®¶ç›´æ¥ä½¿ç”¨æ¥è‡ªä»»ä½•å…¶ä»–äºº (åŒ…æ‹¬ AI) çš„ä»£ç ï¼šâ€œç…§æŠ„â€ ä¼šä½¿ä½ å¤±å»è®­ç»ƒçš„æœºä¼šï¼šå¦‚æœä½ ç‹¬ç«‹ç¼–å†™ï¼Œå¾ˆå¯èƒ½ä¼šé‡åˆ°å„ç§ bugsï¼Œè€Œè§£å†³è¿™äº› bug æ—¶ï¼Œä½ ä¼šä¸æ–­æå‡ºå‡è®¾ã€éªŒè¯å‡è®¾ï¼Œç›´åˆ°ä½ æœ€ç»ˆæŠŠ bug å®šä½åˆ°ä¸€ä¸ªè¶³å¤Ÿå°çš„èŒƒå›´èƒ½å¤Ÿç›´æ¥è§£å†³å®ƒã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä½ ä¼šç§¯ç´¯ â€œåº”è¯¥å¦‚ä½•æå‡ºå’ŒéªŒè¯å‡è®¾â€ çš„ç»éªŒï¼Œè€Œè¿™äº›ç¬¬ä¸€æ‰‹ç»éªŒæ˜¯å¾ˆéš¾é€šè¿‡é˜…è¯»æ–‡æ¡£ (å’Œæ­£ç¡®çš„ä»£ç ) è€Œè·å¾—çš„ã€‚

å½“ç„¶ï¼Œåœ¨ä½ å®ç°å®Œä»¥åï¼Œæˆ‘ä»¬ä¹Ÿé¼“åŠ±å¤§å®¶é˜…è¯»ä¸€äº›å…¶ä»–äººå®ç°çš„ä»£ç ï¼Œä¾‹å¦‚ [musl](https://musl.libc.org/)ï¼Œå¦‚æœä½ å‚è€ƒä¸€äº›æ—©æœŸç‰ˆæœ¬ (ä¾‹å¦‚ [v0.5.0](https://git.musl-libc.org/cgit/musl/tree/src/?h=v0.5.0))ï¼Œå†å¯¹æ¯”æ›´æ–°çš„ç‰ˆæœ¬ï¼Œå°±ä¼šå¯¹åº“å‡½æ•°çš„å®ç°æœ‰æ›´æ·±çš„è®¤è¯†ã€‚

> ##### â˜•ï¸æƒ³è¯•è¯• malloc?
>
> æ²¡é”™ã€‚malloc/free æ˜¯å®ç°æ›´å¤æ‚ç³»ç»Ÿæä¸ºé‡è¦çš„ APIã€‚ä½ å¾ˆæƒ³å®ç°å®ƒâ€”â€”ç„¶åä½ å‘ç° v0.5 çš„ malloc.c å°±å·²ç»æœ‰ 500 è¡Œäº†ï¼æ¥ç€ä½ å‘ç°äº† â€œ__simple_malloc.câ€ï¼š
>
> ```c
> void *__simple_malloc(size_t n)
> {
> 	static uintptr_t cur, brk;
> 	uintptr_t base, new;
> 	static int lock;
> 	size_t align=1;
> 
> 	if (n < SIZE_MAX - ALIGN)
> 		while (align<n && align<ALIGN)
> 			align += align;
> 	n = n + align - 1 & -align;
> 
> 	LOCK(&lock);
> 	if (!cur) cur = brk = __brk(0)+16;
> 	if (n > SIZE_MAX - brk) goto fail;
> 
> 	base = cur + align-1 & -align;
> 	if (base+n > brk) {
> 		new = base+n + PAGE_SIZE-1 & -PAGE_SIZE;
> 		if (__brk(new) != new) goto fail;
> 		brk = new;
> 	}
> 	cur = base+n;
> 	UNLOCK(&lock);
> 
> 	return (void *)base;
> 
> fail:
> 	UNLOCK(&lock);
> 	errno = ENOMEM;
> 	return 0;
> }
> ```
>
>
> åœ¨ â€œå®éªŒä½œä¸šâ€ çš„é˜¶æ®µï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰åšä»€ä¹ˆåˆ›æ–°ï¼Œä½†ç»è¿‡äº†ä½ ç‹¬ç«‹çš„æ€è€ƒï¼Œå†å‚è€ƒä»–äººçš„è§£å†³æ–¹æ¡ˆï¼Œå°±èƒ½è·å¾—å¾ˆå¤šå¯å‘ã€‚æ³¨æ„ä½ å¯ä»¥åœ¨æœ¬åœ°é€šè¿‡ä¿®æ”¹ Makefile ç»•è¿‡æŸäº› warningsï¼Œä½¿ä½ çš„ç¨‹åºçœ‹èµ·æ¥æ­£ç¡®åœ°åœ¨å¤šä¸ªå¹³å°ä¸Šè¿è¡Œï¼›ä½† Online Judge ä¼šä½¿ç”¨æˆ‘ä»¬çš„ Makefile å’Œ AbstractMachine å®ç°ï¼Œå¹¶ä¸”å¯èƒ½ç»è¿‡ä¸€å®šçš„ä¿®æ”¹ (ä¾‹å¦‚è®¾ç½®ä¸ºä¸åŒçš„å±å¹•åˆ†è¾¨ç‡)ã€‚
{: .block-tip}

#### 4.2. è®¿é—® I/O è®¾å¤‡

æ²¡æœ‰åº“å‡½æ•°çš„ C è¯­è¨€ç¨‹åºç±»ä¼¼äºçŠ¶æ€æœºï¼Œåªèƒ½å®Œæˆçº¯ç²¹çš„ â€œè®¡ç®—â€ã€‚TRM ä¸­å”¯ä¸€èƒ½å¤Ÿå’Œå¤–ç•Œäº¤äº’çš„æ‰‹æ®µæ˜¯ `putch()` åœ¨è°ƒè¯•ç»ˆç«¯ä¸Šæ‰“å°å­—ç¬¦å’Œ `halt()` ç»ˆæ­¢ç¨‹åºã€‚æˆ‘ä»¬çš„ç¡¬ä»¶æä¾›äº†è‹¥å¹² I/O è®¾å¤‡ï¼ŒAbstractMachine å¯ä»¥é€šè¿‡ IOE è®¿é—®å®ƒä»¬ã€‚åœ¨è°ƒç”¨ I/O è®¾å¤‡ä¹‹å‰ï¼Œéœ€è¦è°ƒç”¨ `ioe_init()` åˆå§‹åŒ–ï¼Œç„¶åå°±å¯ä»¥ç”¨

```c
void ioe_read (int reg, void *buf);
void ioe_write(int reg, void *buf);
```


ä¸¤ä¸ªå‡½æ•°è®¿é—® AbstractMachine ä¸­çš„ I/O â€œå¯„å­˜å™¨â€ äº†ã€‚è¯¦æƒ…è¯·å‚è€ƒ AbstractMachine æ–‡æ¡£å’Œæ¡†æ¶ä»£ç ã€‚åœ¨ `klib-macros.h` ä¸­åŒ…å«äº†æ›´ç®€åŒ–çš„ I/O å¯„å­˜å™¨è®¿é—®æ–¹æ³• `io_read` å’Œ `io_write`ï¼Œè¯·å¤§å®¶æŸ¥çœ‹ã€‚ç”¨è¿™ç»„ API ä½ å°±å¯ä»¥çœå»æ‰‹å·¥å®šä¹‰å˜é‡çš„éº»çƒ¦ï¼Œä¾‹å¦‚ç›´æ¥

```c
int width = io_read(AM_GPU_CONFIG).width;
```


åˆ°è¿™é‡Œï¼Œå¤§å®¶å¯èƒ½ä¼šäº§ç”Ÿçš„ä¸€ä¸ªç–‘é—®æ˜¯ï¼šè¿è¡Œåœ¨ â€œè£¸æœºâ€ ä¸Šçš„ç¨‹åºå¯ä»¥ç”¨å“ªäº›æ ‡å‡†åº“ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œlibc ä¸­ç›¸å½“ä¸€éƒ¨åˆ†å‡½æ•°éƒ½è°ƒç”¨æ“ä½œç³»ç»Ÿï¼Œä¾‹å¦‚ `printf`, `malloc` ç­‰ï¼Œå³ä¾¿å¼•ç”¨äº† `stdio.h` è¿™æ ·çš„å¤´æ–‡ä»¶ï¼Œå®ƒä»¬çš„å®ç°ä¾ç„¶æ˜¯ç¼ºå¤±çš„ï¼›å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å¼•ç”¨äº†ä¸€äº›åº“çš„å¤´æ–‡ä»¶ï¼Œä¾‹å¦‚ `stdint.h` (åŒ…å«è¯¸å¦‚ `int32_t` è¿™äº›ç±»å‹çš„å®šä¹‰)ã€`stdarg.h` ç­‰ï¼Œå´å¯ä»¥æ­£å¸¸å·¥ä½œã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ

äº‹å®ä¸Šï¼ŒAbstractMachine çš„ç¨‹åºè¿è¡Œåœ¨ [freestandingçš„ç¯å¢ƒä¸‹](https://wiki.osdev.org/C_Library) (æ“ä½œç³»ç»Ÿä¸Šçš„ C ç¨‹åºè¿è¡Œåœ¨ hosted ç¯å¢ƒä¸‹)ï¼š

> The `__STDC_HOSTED__` macro expands to `1` on hosted implementations, or 0 on freestanding ones. The freestanding headers are: `float.h`, `iso646.h`, `limits.h`, `stdalign.h`, `stdarg.h`, `stdbool.h`, `stddef.h`, `stdint.h`, and `stdnoreturn.h`. You should be familiar with these headers as they contain useful declarations you shouldn't do yourself. GCC also comes with additional freestanding headers for CPUID, SSE and such.
{: .block-tip}

è¿™äº›å¤´æ–‡ä»¶ä¸­åŒ…å«äº† freestanding ç¨‹åºä¹Ÿå¯ä½¿ç”¨çš„å£°æ˜ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‘ç°ï¼Œå¯å˜å‚æ•°ç»è¿‡é¢„ç¼–è¯‘åç”Ÿæˆäº†ç±»ä¼¼ `__builtin_va_arg` çš„ builtin è°ƒç”¨ï¼Œç”±ç¼–è¯‘å™¨ç¿»è¯‘æˆäº†ç‰¹å®šçš„æ±‡ç¼–ä»£ç ã€‚

#### 4.3. ç»˜åˆ¶ä¸€ä¸ªå›¾ç‰‡

â€œç»˜åˆ¶ä¸€ä¸ªå›¾ç‰‡â€ ä¼¼ä¹æ˜¯ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„éœ€æ±‚ã€‚ç„¶è€Œï¼Œä½ å¾ˆå¿«ä¹Ÿååº”è¿‡æ¥ï¼šâ€œå›¾ç‰‡ä¸è¿‡æ˜¯è®¡ç®—æœºä¸­ä¿å­˜çš„ 01 æ•°æ®â€ã€‚é‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦‚ä½•åœ¨ C
è¯­è¨€ä¸­ä¿å­˜ç¨‹åºè¿è¡Œå‰çš„æ•°æ®çš„ï¼Ÿç­”æ¡ˆæ˜¯å®šä¹‰å¸¦åˆå€¼çš„å…¨å±€å˜é‡ï¼š

```c
const char *names = {
    "Tom",
    "Jerry",
    "Spike",
    ...
};
```


æˆ‘ä»¬åªè¦æŠŠå›¾ç‰‡çš„ RGB æ•°å€¼å†™åœ¨ä»£ç é‡Œï¼Œä¸å°±å¯ä»¥æ˜¾ç¤ºå›¾ç‰‡äº†å—ï¼æ²¡é”™ã€‚ç”šè‡³æˆ‘ä»¬çš„ xxd å·¥å…·éƒ½å¸®åŠ©å¤§å®¶å®ç°äº†è¿™ä¸€ç‚¹ï¼š

```c
// Generated by: xxd -i /bin/ls
unsigned char _bin_ls[] = {
    0x7f, 0x45, 0x4c, 0x46, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x3e, 0x00, 0x01, 0x00, 0x00, 0x00,
    ...
    0x00, 0x00, 0x00, 0x00
};
unsigned int _bin_ls_len = 142144;
```

`xxd` å¯ä»¥å°†ä»»ä½•äºŒè¿›åˆ¶æ–‡ä»¶è½¬æ¢æˆ C/C++ å¯ä»¥æ¥å—çš„å¸¸é‡æ•°ç»„ï¼Œè€Œä¸”æŠŠæ•°ç»„çš„é•¿åº¦ä¹Ÿå›ºå®šå¥½ã€‚å› æ­¤ä½ å¯ä»¥åœ¨ â€œkernelâ€ çš„å¤–éƒ¨å‡†å¤‡å¥½ä»»ä½•çš„å›¾ç‰‡æ•°æ®ã€‚è‡³äºåŒä¸€ä¸ªå›¾ç‰‡å¦‚ä½• â€œæ‹‰ä¼¸/ç¼©æ”¾â€ åˆ°ä¸åŒåˆ†è¾¨ç‡ï¼Œè¿™å°±æ˜¯ä½ éœ€è¦è€ƒè™‘çš„é—®é¢˜äº†â€”â€”ä¸è¿‡è¿™ä¹Ÿä¸éš¾ï¼Œè¯´ç™½äº†ä½ æ˜¯å¸Œæœ›å°†ä¸€ä¸ªnÃ—m çš„çŸ©å½¢ç½‘æ ¼ â€œæŠ•å½±â€ åˆ°ä¸€ä¸ª nâ€²Ã—mâ€² çš„çŸ©å½¢ç½‘æ ¼ä¸Šâ€”â€”å› æ­¤æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯åœ¨æ–°ç½‘æ ¼ä¸Šæ‰¾åˆ°æ—§ç½‘æ ¼ â€œæœ€é è¿‘â€ çš„é‚£ä¸ªä½ç½®å¯¹åº”çš„åƒç´ å³å¯ã€‚
